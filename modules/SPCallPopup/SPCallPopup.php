<?php
require_once 'data/CRMEntity.php'; require_once 'vtlib/Vtiger/Link.php'; require_once 'vtlib/Vtiger/Module.php'; require_once 'vtlib/Vtiger/Menu.php'; require_once 'include/events/include.inc'; require_once 'include/utils/utils.php'; require_once 'modules/ModTracker/ModTrackerUtils.php'; require_once 'modules/Vtiger/CRMEntity.php'; class SPCallPopup extends Vtiger_CRMEntity { private $headerScriptType = 'HEADERSCRIPT'; private $cssType = 'HEADERCSS'; var $db, $log; var $table_name = 'vtiger_sp_callpopup'; var $table_index = 'popupid'; var $column_fields = array(); var $customFieldTable = array('vtiger_sp_callpopupcf', 'popupid'); var $tab_name = array('vtiger_crmentity', 'vtiger_sp_callpopup', 'vtiger_sp_callpopupcf'); var $tab_name_index = array('vtiger_crmentity' => 'crmid', 'vtiger_sp_callpopup' => 'popupid', 'vtiger_sp_callpopupcf' => 'popupid'); function __construct() { global $sp6164a6; $this->column_fields = getColumnFields('SPCallPopup'); $this->db = PearDatabase::getInstance(); $this->log = $sp6164a6; } function vtlib_handler($spff2c58, $sp538247) { $sp155c09 = Vtiger_Module_Model::getInstance('Accounts'); $spc5983e = Vtiger_Module_Model::getInstance('Leads'); $sp4f224e = Vtiger_Module_Model::getInstance('Contacts'); $sp7824b4 = Vtiger_Module_Model::getInstance('PBXManager'); $spadb6dd = Vtiger_Module_Model::getInstance('SPCallPopup'); if ($sp538247 == 'module.postinstall') { $this->spd81e12(); $this->sp1f453b(); $this->spdd1a50(); $this->spf14564(); $this->sp0eb17f(); $sp155c09->setRelatedList($spadb6dd, 'SPCallPopup', array()); $spc5983e->setRelatedList($spadb6dd, 'SPCallPopup', array()); $sp4f224e->setRelatedList($spadb6dd, 'SPCallPopup', array()); $sp7824b4->setRelatedList($spadb6dd, 'SPCallPopup', array()); $spadb6dd->setRelatedList($sp155c09, 'Accounts', array()); $spadb6dd->setRelatedList($spc5983e, 'Leads', array()); $spadb6dd->setRelatedList($sp4f224e, 'Contacts', array()); $spadb6dd->setRelatedList($sp7824b4, 'PBXManager', array()); } else { if ($sp538247 == 'module.disabled') { $this->spd81e12(); $this->spfc204d(); $sp155c09->unsetRelatedList($spadb6dd); $spc5983e->unsetRelatedList($spadb6dd); $sp4f224e->unsetRelatedList($spadb6dd); $sp7824b4->unsetRelatedList($spadb6dd); $spadb6dd->unsetRelatedList($sp155c09); $spadb6dd->unsetRelatedList($spc5983e); $spadb6dd->unsetRelatedList($sp4f224e); $spadb6dd->unsetRelatedList($sp7824b4); } else { if ($sp538247 == 'module.enabled') { $this->spd81e12(); $this->sp1f453b(); $this->spdd1a50(); $sp155c09->unsetRelatedList($spadb6dd); $spc5983e->unsetRelatedList($spadb6dd); $sp4f224e->unsetRelatedList($spadb6dd); $sp7824b4->unsetRelatedList($spadb6dd); $spadb6dd->unsetRelatedList($sp155c09); $spadb6dd->unsetRelatedList($spc5983e); $spadb6dd->unsetRelatedList($sp4f224e); $spadb6dd->unsetRelatedList($sp7824b4); $sp155c09->setRelatedList($spadb6dd, 'SPCallPopup', array()); $spc5983e->setRelatedList($spadb6dd, 'SPCallPopup', array()); $sp4f224e->setRelatedList($spadb6dd, 'SPCallPopup', array()); $sp7824b4->setRelatedList($spadb6dd, 'SPCallPopup', array()); $spadb6dd->setRelatedList($sp155c09, 'Accounts', array()); $spadb6dd->setRelatedList($spc5983e, 'Leads', array()); $spadb6dd->setRelatedList($sp4f224e, 'Contacts', array()); $spadb6dd->setRelatedList($sp7824b4, 'PBXManager', array()); } else { if ($sp538247 == 'module.preuninstall') { $this->spd81e12(); $this->spfc204d(); $sp155c09->unsetRelatedList($spadb6dd); $spc5983e->unsetRelatedList($spadb6dd); $sp4f224e->unsetRelatedList($spadb6dd); $sp7824b4->unsetRelatedList($spadb6dd); $spadb6dd->unsetRelatedList($sp155c09); $spadb6dd->unsetRelatedList($spc5983e); $spadb6dd->unsetRelatedList($sp4f224e); $spadb6dd->unsetRelatedList($sp7824b4); } else { if ($sp538247 == 'module.preupdate') { } else { if ($sp538247 == 'module.postupdate') { } } } } } } } public function save_module($sp739fec) { } public function generateReportsQuery($sp739fec, $spba1a94) { $sp95a9dc = parent::generateReportsQuery($sp739fec, $spba1a94); if ($spba1a94->requireTable('vtiger_pbxmanagerRelPBXManager')) { $sp95a9dc .= ' LEFT JOIN vtiger_pbxmanager AS vtiger_pbxmanagerRelPBXManager ON vtiger_pbxmanagerRelPBXManager.pbxmanagerid=vtiger_sp_callpopup.callid '; } if ($spba1a94->requireTable('vtiger_leaddetailsRelLeads')) { if (!$spba1a94->requireTable('vtiger_pbxmanagerRelPBXManager')) { $spba1a94->addTable('vtiger_pbxmanagerRelPBXManager'); $sp95a9dc .= ' LEFT JOIN vtiger_pbxmanager AS vtiger_pbxmanagerRelPBXManager ON vtiger_pbxmanagerRelPBXManager.pbxmanagerid=vtiger_sp_callpopup.callid '; } $sp95a9dc .= ' LEFT JOIN vtiger_leaddetails AS vtiger_leaddetailsRelLeads ON vtiger_leaddetailsRelLeads.leadid=vtiger_pbxmanagerRelPBXManager.customer '; } if ($spba1a94->requireTable('vtiger_contactdetailsRelContacts')) { if (!$spba1a94->requireTable('vtiger_pbxmanagerRelPBXManager')) { $spba1a94->addTable('vtiger_pbxmanagerRelPBXManager'); $sp95a9dc .= ' LEFT JOIN vtiger_pbxmanager AS vtiger_pbxmanagerRelPBXManager ON vtiger_pbxmanagerRelPBXManager.pbxmanagerid=vtiger_sp_callpopup.callid '; } $sp95a9dc .= ' LEFT JOIN vtiger_contactdetails AS vtiger_contactdetailsRelContacts ON vtiger_contactdetailsRelContacts.contactid=vtiger_pbxmanagerRelPBXManager.customer '; } if ($spba1a94->requireTable('vtiger_accountRelAccounts')) { if (!$spba1a94->requireTable('vtiger_pbxmanagerRelPBXManager')) { $spba1a94->addTable('vtiger_pbxmanagerRelPBXManager'); $sp95a9dc .= ' LEFT JOIN vtiger_pbxmanager AS vtiger_pbxmanagerRelPBXManager ON vtiger_pbxmanagerRelPBXManager.pbxmanagerid=vtiger_sp_callpopup.callid '; } $sp95a9dc .= ' LEFT JOIN vtiger_account AS vtiger_accountRelAccounts ON vtiger_accountRelAccounts.accountid=vtiger_pbxmanagerRelPBXManager.customer '; } return $sp95a9dc; } public function generateReportsSecQuery($sp739fec, $sp57df11, $spba1a94) { $sp95a9dc = parent::generateReportsSecQuery($sp739fec, $sp57df11, $spba1a94); if ($spba1a94->requireTable('vtiger_pbxmanagerRelPBXManager')) { $sp95a9dc .= ' LEFT JOIN vtiger_pbxmanager AS vtiger_pbxmanagerRelPBXManager ON vtiger_pbxmanagerRelPBXManager.pbxmanagerid=vtiger_sp_callpopup.callid '; } return $sp95a9dc; } public static function isOldVersion() { $spaa773a = Vtiger_Version::current(); return strpos($spaa773a, '6') === 0; } private function sp0eb17f() { vimport('~~modules/com_vtiger_workflow/include.inc'); vimport('~~modules/com_vtiger_workflow/tasks/VTEntityMethodTask.inc'); vimport('~~modules/com_vtiger_workflow/VTEntityMethodManager.inc'); vimport('~~modules/com_vtiger_workflow/VTTaskManager.inc'); $sp376434 = PearDatabase::getInstance(); $spe80df8 = new VTWorkflowManager($sp376434); $sp85a6f6 = $spe80df8->newWorkFlow('SPCallPopup'); $sp85a6f6->test = '[{"fieldname":"status","operation":"is","value":"1","valuetype":"rawtext","joincondition":"","groupjoin":"and","groupid":"0"}]'; $sp85a6f6->description = 'Create Client if not exists and bind call to him'; $sp85a6f6->name = 'Create Client if not exists and bind call to him'; $sp85a6f6->status = 1; $sp85a6f6->executionCondition = 3; $sp85a6f6->defaultworkflow = 1; $spe80df8->save($sp85a6f6); $sp30276f = new VTEntityMethodManager($sp376434); $sp30276f->addEntityMethod('SPCallPopup', 'SPCallPopupCustomTask', 'modules/SPCallPopup/tasks/SPCallPopupCustomTask.php', 'SPCallPopupCustomTask'); $spf25d7a = new VTTaskManager($sp376434); $spa8b394 = $spf25d7a->createTask('VTEntityMethodTask', $sp85a6f6->id); $spa8b394->active = true; $spa8b394->summary = 'Create Client if not exists and bind call to him'; $spa8b394->methodName = 'SPCallPopupCustomTask'; $spf25d7a->saveTask($spa8b394); } private function spdd1a50() { $spe6e730 = array('path' => 'modules/SPCallPopup/SPCallPopup.php', 'class' => 'SPCallPopup', 'method' => 'checkLinkPermission'); $spc9f443 = getTabid('SPCallPopup'); Vtiger_Link::addLink($spc9f443, $this->headerScriptType, 'Visibility', 'modules/SPCallPopup/resources/visibility.min.js'); if (self::isOldVersion()) { Vtiger_Link::addLink($spc9f443, $this->headerScriptType, 'Call popup fields', 'modules/SPCallPopup/resources/SPCallPopup.js', '', '', $spe6e730); } else { Vtiger_Link::addLink($spc9f443, $this->headerScriptType, 'Call popup fields', 'modules/SPCallPopup/resources/SPCallPopup7.js', '', '', $spe6e730); Vtiger_Link::addLink($spc9f443, $this->headerScriptType, 'Pnotify', 'libraries/jquery/pnotify/jquery.pnotify.min.js'); Vtiger_Link::addLink($spc9f443, $this->cssType, 'Pnotify styles', 'libraries/jquery/pnotify/jquery.pnotify.default.css'); Vtiger_Link::addLink($spc9f443, $this->cssType, 'Custom styles', 'modules/SPCallPopup/resources/SPCallPopup7.css'); } $sp45be45 = CRMEntity::getInstance('PBXManager'); $sp45be45->removeLinksForPBXManager(); } private function spfc204d() { $spc9f443 = getTabid('SPCallPopup'); Vtiger_Link::deleteLink($spc9f443, $this->headerScriptType, 'Visibility', 'modules/SPCallPopup/resources/visibility.min.js'); if (self::isOldVersion()) { Vtiger_Link::deleteLink($spc9f443, $this->headerScriptType, 'Call popup fields', 'modules/SPCallPopup/resources/SPCallPopup.js'); } else { Vtiger_Link::deleteLink($spc9f443, $this->headerScriptType, 'Call popup fields', 'modules/SPCallPopup/resources/SPCallPopup7.js'); Vtiger_Link::deleteLink($spc9f443, $this->headerScriptType, 'Pnotify', 'libraries/jquery/pnotify/jquery.pnotify.min.js'); Vtiger_Link::deleteLink($spc9f443, $this->cssType, 'Pnotify styles', 'libraries/jquery/pnotify/jquery.pnotify.default.css'); Vtiger_Link::deleteLink($spc9f443, $this->cssType, 'Custom styles', 'modules/SPCallPopup/resources/SPCallPopup7.css'); } $sp32a4c3 = Vtiger_Module_Model::getInstance('PBXManager'); if ($sp32a4c3->isActive()) { $sp45be45 = CRMEntity::getInstance('PBXManager'); $sp45be45->addLinksForPBXManager(); } } public function checkLinkPermission($spcc5957) { $sp739fec = new Vtiger_Module(); $spe88718 = $sp739fec->getInstance('SPCallPopup'); if ($spe88718) { return true; } else { return false; } } private function sp1f453b() { $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->query('SELECT COUNT(*) AS calls_count FROM vtiger_sp_callpopup_last_call'); if ($sped8be5) { $spbdf8bd = $sp376434->fetchByAssoc($sped8be5); if ($spbdf8bd['calls_count'] == 0) { $sp376434->pquery('INSERT INTO vtiger_sp_callpopup_last_call VALUES(?)', array(0)); } } $sped8be5 = $sp376434->query('SELECT MAX(pbxmanagerid) AS last_call_id FROM vtiger_pbxmanager'); if ($sped8be5) { if ($spbdf8bd = $sp376434->fetchByAssoc($sped8be5)) { $sp376434->pquery('UPDATE vtiger_sp_callpopup_last_call SET last_call_id=?', array($spbdf8bd['last_call_id'])); } } } private function spd81e12() { $spc9f443 = getTabid('SPCallPopup'); ModTrackerUtils::modTrac_changeModuleVisibility($spc9f443, 'module_disable'); } private function spf14564() { $sp0669d1 = Vtiger_Module_Model::getInstance('SPCallPopup'); $spe07b1f = Vtiger_Module_Model::getInstance('Leads'); $spe1ee35 = Vtiger_Module_Model::getInstance('Contacts'); $sped1269 = Vtiger_Module_Model::getInstance('Accounts'); $spfb9588 = array(); $spc8d7df = Vtiger_Field_Model::getInstance('lastname', $spe07b1f); $sp2964c9 = Vtiger_Field_Model::getInstance('lastname', $spe1ee35); $sp391033 = Vtiger_Field_Model::getInstance('lastname', $sp0669d1); if (($spc8d7df || $sp2964c9) && $sp391033) { $spfb9588[] = array('popup' => $sp391033->getId(), 'lead' => $spc8d7df ? $spc8d7df->getId() : 0, 'contact' => $sp2964c9 ? $sp2964c9->getId() : 0, 'account' => 0); } $sp1b8a08 = Vtiger_Field_Model::getInstance('firstname', $spe07b1f); $spe1cf0b = Vtiger_Field_Model::getInstance('firstname', $spe1ee35); $spb71a06 = Vtiger_Field_Model::getInstance('firstname', $sp0669d1); if (($sp1b8a08 || $spe1cf0b) && $spb71a06) { $spfb9588[] = array('popup' => $spb71a06->getId(), 'lead' => $sp1b8a08 ? $sp1b8a08->getId() : 0, 'contact' => $spe1cf0b ? $spe1cf0b->getId() : 0, 'account' => 0); } $sp60b69b = Vtiger_Field_Model::getInstance('accountname', $sped1269); $sp233c5a = Vtiger_Field_Model::getInstance('accountname', $sp0669d1); if ($sp60b69b && $sp233c5a) { $spfb9588[] = array('popup' => $sp233c5a->getId(), 'lead' => 0, 'contact' => 0, 'account' => $sp60b69b->getId()); } $spa95f1e = new Settings_SPCallPopup_Mapping_Model(); $spa95f1e->createMappings($spfb9588); } } class SPCallPopup_Record_Model extends Vtiger_Record_Model { public function getCallModel() { $sp22e908 = $this->get('callid'); if (!empty($sp22e908)) { $sp2fa9aa = PBXManager_Record_Model::getInstanceById($sp22e908); $spd28461 = $sp2fa9aa->get('pbxmanagerid'); if (!empty($spd28461)) { return $sp2fa9aa; } } return null; } public function getClientModel() { $sp670866 = null; $sp34464a = $this->getCallModel(); $spc5e0b0 = $sp34464a->get('customer'); if (!empty($spc5e0b0) && !self::isEntityDeleted($spc5e0b0)) { $sp670866 = Vtiger_Record_Model::getInstanceById($spc5e0b0); } return $sp670866; } public function getCallStatusDisplay() { $sp69e389 = ''; $sp34464a = $this->getCallModel(); if ($sp34464a != null) { $sp0d4b66 = ''; if ($sp34464a->get('direction') == 'inbound') { $sp0d4b66 = 'icon-arrow-down icon-white'; } else { $sp0d4b66 = 'icon-arrow-up icon-white'; } switch ($sp34464a->get('callstatus')) { case 'in-progress': case 'ringing': $sp69e389 = '<span class="label label-info"><i class="' . $sp0d4b66 . '"></i>' . vtranslate($sp34464a->get('callstatus'), 'PBXManager') . '</span>'; break; case 'completed': $sp69e389 = '<span class="label label-success"><i class="' . $sp0d4b66 . '"></i>' . vtranslate($sp34464a->get('callstatus'), 'PBXManager') . '</span>'; break; case 'no-answer': $sp69e389 = '<span class="label label-important"><i class="' . $sp0d4b66 . '"></i>' . vtranslate($sp34464a->get('callstatus'), 'PBXManager') . '</span>'; break; default: $sp69e389 = '<span class="label label-warning"><i class="' . $sp0d4b66 . '"></i>' . vtranslate($sp34464a->get('callstatus'), 'PBXManager') . '</span>'; break; } } return $sp69e389; } public static function isEntityDeleted($spc5e0b0) { $spc5e0b0 = (int) $spc5e0b0; if ($spc5e0b0 <= 0) { return true; } $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->pquery('SELECT crmid FROM vtiger_crmentity WHERE crmid=? AND deleted=1', array($spc5e0b0)); if (!$sped8be5) { return true; } return $sp376434->fetchByAssoc($sped8be5) != null; } } class SPCallPopup_Module_Model extends Vtiger_Module_Model { const INCOMING_CALL_DIRECTION = 'inbound'; public function isQuickCreateSupported() { return false; } public function getSettingLinks() { $sp6ddf2a = Users_Record_Model::getCurrentUserModel(); $spd51a1f = parent::getSettingLinks(); if ($sp6ddf2a->isAdminUser()) { $spd51a1f[] = array('linktype' => 'LISTVIEWSETTING', 'linklabel' => vtranslate('LBL_SPCALLPOPUP_FIELD_MAPPING', 'Settings:SPCallPopup'), 'linkurl' => 'index.php?parent=Settings&module=' . $this->getName() . '&view=MappingDetail', 'linkicon' => ''); } return $spd51a1f; } public function getHoldedPopups() { $sp376434 = PearDatabase::getInstance(); $sp038564 = Users_Record_Model::getCurrentUserModel(); $sped8be5 = $sp376434->pquery('SELECT popupid FROM vtiger_sp_callpopup ' . 'INNER JOIN vtiger_crmentity ON vtiger_sp_callpopup.popupid=vtiger_crmentity.crmid ' . 'WHERE vtiger_sp_callpopup.status=? AND vtiger_crmentity.smownerid=? ' . 'AND vtiger_sp_callpopup.callid IS NOT NULL AND vtiger_sp_callpopup.callid!=0 LIMIT 5', array(0, $sp038564->getId())); $spdbd81c = array(); while ($spbdf8bd = $sp376434->fetchByAssoc($sped8be5)) { $sp843449 = SPCallPopup_Record_Model::getInstanceById($spbdf8bd['popupid'], $this->getName()); $sp34464a = $sp843449->getCallModel(); if ($sp34464a != null && $sp34464a->get('callstatus') == 'in-progress') { $this->spf509e2($sp34464a); } $spdbd81c[] = $sp843449; } return $spdbd81c; } private function spf509e2($sp34464a) { $sp8b3855 = $this->spd2a5d9($sp34464a); $sp376434 = PearDatabase::getInstance(); if (!empty($sp8b3855)) { $sp5e7fab = $sp8b3855; array_unshift($sp5e7fab, 1); $sp376434->pquery('UPDATE vtiger_sp_callpopup SET status=? WHERE vtiger_sp_callpopup.callid IN (' . generateQuestionMarks($sp8b3855) . ')', $sp5e7fab); } } private function spd2a5d9($sp34464a) { $sp8b3855 = array(); $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->pquery('SELECT pbxmanagerid FROM vtiger_pbxmanager WHERE ' . 'callstatus!=? AND sourceuuid=?', array('in-progress', $sp34464a->get('sourceuuid'))); if ($sped8be5) { while ($spfa9c85 = $sp376434->fetchByAssoc($sped8be5)) { $sp8b3855[] = $spfa9c85['pbxmanagerid']; } } return $sp8b3855; } public function createPopupHoldersForNewCalls() { $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->query('SELECT last_call_id FROM vtiger_sp_callpopup_last_call LIMIT 1'); $sp675c21 = 0; if ($sped8be5 && ($spbdf8bd = $sp376434->fetchByAssoc($sped8be5))) { $sp675c21 = $spbdf8bd['last_call_id']; } $sped8be5 = $sp376434->query('SELECT MAX(callid) AS last_popup_call_id FROM vtiger_sp_callpopup'); if ($sped8be5 && ($spbdf8bd = $sp376434->fetchByAssoc($sped8be5)) && $spbdf8bd['last_popup_call_id'] > $sp675c21) { $sp675c21 = $spbdf8bd['last_popup_call_id']; } $sp038564 = Users_Record_Model::getCurrentUserModel(); $sped8be5 = $sp376434->pquery('SELECT pbxmanagerid, customer FROM vtiger_pbxmanager WHERE pbxmanagerid>? AND user=?', array($sp675c21, $sp038564->getId())); if ($sped8be5) { while ($spbdf8bd = $sp376434->fetchByAssoc($sped8be5)) { $spc074ec = Vtiger_Record_Model::getCleanInstance('SPCallPopup'); $spc074ec->set('callid', $spbdf8bd['pbxmanagerid']); $spc074ec->save(); $spfa691b = Vtiger_Module_Model::getInstance('PBXManager'); $sp63e4bf = Vtiger_Relation_Model::getInstance($this, $spfa691b); if ($sp63e4bf) { $sp63e4bf->addRelation($spc074ec->getId(), $spc074ec->get('callid')); } $sp63e4bf = Vtiger_Relation_Model::getInstance($spfa691b, $this); if ($sp63e4bf) { $sp63e4bf->addRelation($spc074ec->get('callid'), $spc074ec->getId()); } } } } public function markPopupProcessed($sp10c008) { $sp376434 = PearDatabase::getInstance(); $sp376434->pquery('UPDATE vtiger_sp_callpopup SET status=? WHERE popupid=?', array(1, $sp10c008)); } public function markAllCurrentUserPopupsProcessed() { $sp038564 = Users_Record_Model::getCurrentUserModel(); $sp376434 = PearDatabase::getInstance(); $sp376434->pquery('UPDATE vtiger_sp_callpopup INNER JOIN vtiger_crmentity ON vtiger_crmentity.crmid=vtiger_sp_callpopup.popupid ' . ' SET vtiger_sp_callpopup.status=? WHERE vtiger_crmentity.smownerid=?', array(1, $sp038564->getId())); } public function markPopupUnprocessed($sp10c008) { $sp376434 = PearDatabase::getInstance(); $sp376434->pquery('UPDATE vtiger_sp_callpopup SET status=? WHERE popupid=?', array(0, $sp10c008)); } } class SPCallPopup_CancelAllPopups_Action extends Vtiger_Action_Controller { public function checkPermission(Vtiger_Request $sp6774fb) { $sp32a4c3 = Vtiger_Module_Model::getInstance('PBXManager'); $sp3029f5 = Users_Privileges_Model::getCurrentUserPrivilegesModel(); if (!$sp3029f5->hasModulePermission($sp32a4c3->getId())) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } } public function process(Vtiger_Request $sp6774fb) { $sp7a5f0f = Vtiger_Module_Model::getInstance($sp6774fb->getModule()); $sp7a5f0f->markAllCurrentUserPopupsProcessed(); $sp6096a7 = new Vtiger_Response(); $sp6096a7->setResult(true); $sp6096a7->emit(); } } class SPCallPopup_CancelPopup_Action extends Vtiger_Action_Controller { public function checkPermission(Vtiger_Request $sp6774fb) { $sp32a4c3 = Vtiger_Module_Model::getInstance('PBXManager'); $sp3029f5 = Users_Privileges_Model::getCurrentUserPrivilegesModel(); if (!$sp3029f5->hasModulePermission($sp32a4c3->getId())) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } } public function process(Vtiger_Request $sp6774fb) { $sp7a5f0f = Vtiger_Module_Model::getInstance($sp6774fb->getModule()); $sp7a5f0f->markPopupProcessed($sp6774fb->get('popupId')); $sp6096a7 = new Vtiger_Response(); $sp6096a7->setResult(true); $sp6096a7->emit(); } } class SPCallPopup_CheckPollAccess_Action extends Vtiger_Action_Controller { public function checkPermission(Vtiger_Request $sp6774fb) { $sp32a4c3 = Vtiger_Module_Model::getInstance('PBXManager'); $sp3029f5 = Users_Privileges_Model::getCurrentUserPrivilegesModel(); if (!$sp3029f5->hasModulePermission($sp32a4c3->getId())) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } } public function process(Vtiger_Request $sp6774fb) { $spc33e61 = Users_Record_Model::getCurrentUserModel(); $sp003d7f = $spc33e61->get('phone_crm_extension'); $sp6096a7 = new Vtiger_Response(); $sp6096a7->setResult($sp003d7f != null); $sp6096a7->emit(); } } class SPCallPopup_RefreshContent_Action extends SPCallPopup_GetCalls_Action { public function process(\Vtiger_Request $sp6774fb) { $spf92122 = $sp6774fb->getModule(); $sp6096a7 = new Vtiger_Response(); $sp236f41 = Vtiger_Record_Model::getInstanceById($sp6774fb->get('recordId')); $sp5b1318 = Vtiger_RecordStructure_Model::getInstanceFromRecordModel($sp236f41, Vtiger_RecordStructure_Model::RECORD_STRUCTURE_MODE_EDIT); $sp5b1318->filterBySelectedModule($sp6774fb->get('mappingModule')); $spe5b48c = $this->getViewer($sp6774fb); $spe5b48c->assign('RECORD_STRUCTURE_MODEL', $sp5b1318); $spe5b48c->assign('RECORD_STRUCTURE', $sp5b1318->getStructure()); $spe5b48c->assign('MODULE', $spf92122); $spe5b48c->assign('CURRENTDATE', date('Y-n-j')); $spe5b48c->assign('USER_MODEL', Users_Record_Model::getCurrentUserModel()); $sp6096a7->setResult($spe5b48c->view('PopupContents.tpl', $spf92122, true)); $sp6096a7->emit(); } } class SPCallPopup_GetCalls_Action extends Vtiger_Action_Controller { private $viewer; public function checkPermission(Vtiger_Request $sp6774fb) { $sp32a4c3 = Vtiger_Module_Model::getInstance('PBXManager'); $sp3029f5 = Users_Privileges_Model::getCurrentUserPrivilegesModel(); if (!$sp3029f5->hasModulePermission($sp32a4c3->getId())) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } } public function process(Vtiger_Request $sp6774fb) { $spf92122 = $sp6774fb->getModule(); $sp7a5f0f = Vtiger_Module_Model::getInstance($spf92122); $sp7a5f0f->createPopupHoldersForNewCalls(); $sped8be5 = array(); foreach ($sp7a5f0f->getHoldedPopups() as $spbf0a83) { $sp34464a = $spbf0a83->getCallModel(); $sped8be5[] = array('popupId' => $spbf0a83->getId(), 'callStatus' => $spbf0a83->getCallStatusDisplay(), 'direction' => vtranslate($sp34464a->get('direction'), $spf92122), 'popupContents' => $this->sp288d06($sp6774fb, $spbf0a83)); } $sp6096a7 = new Vtiger_Response(); $sp6096a7->setResult($sped8be5); $sp6096a7->emit(); } public function getViewer(Vtiger_Request $sp6774fb) { if (!$this->viewer) { $spe5b48c = new Vtiger_Viewer(); $this->viewer = $spe5b48c; } return $this->viewer; } private function sp288d06(Vtiger_Request $sp6774fb, $spbf0a83) { $spf92122 = $sp6774fb->getModule(); $sp34464a = $spbf0a83->getCallModel(); $spa95f1e = Settings_SPCallPopup_Mapping_Model::getCleanInstance(); $sp573574 = Vtiger_DependencyPicklist::getPicklistDependencyDatasource($spf92122); $spc9f443 = getTabid($spf92122); $spcd2829 = getDBValidationData($spbf0a83->get('tab_name'), $spc9f443); $sp8461b4 = split_validationdataArray($spcd2829); $sp5b1318 = Vtiger_RecordStructure_Model::getInstanceFromRecordModel($spbf0a83, Vtiger_RecordStructure_Model::RECORD_STRUCTURE_MODE_EDIT); $sp670866 = $spbf0a83->getClientModel(); if ($sp670866 != null) { $sp5b1318->removeMappingFields(); } else { $sp5b1318->filterBySelectedModule($spa95f1e->getDefaultMappingModuleName()); } $spe5b48c = $this->getViewer($sp6774fb); $spe5b48c->assign('MODE', ''); $spe5b48c->assign('MAPPING_MODULE', $spa95f1e->getDefaultMappingModuleName()); $spe5b48c->assign('MAPPIGNS_MODULES', $spa95f1e->getSupportedModulesList()); $spe5b48c->assign('POPUP', $spbf0a83); $spe5b48c->assign('RECORD_ID', $spbf0a83->getId()); $spe5b48c->assign('CALL_MODEL', $sp34464a); $spe5b48c->assign('CALL_USER', Users_Record_Model::getInstanceById($sp34464a->get('user'), 'Users')); $spe5b48c->assign('VALIDATION_DATA_FIELDNAME', $sp8461b4['fieldname']); $spe5b48c->assign('VALIDATION_DATA_FIELDDATATYPE', $sp8461b4['datatype']); $spe5b48c->assign('VALIDATION_DATA_FIELDLABEL', $sp8461b4['fieldlabel']); $spe5b48c->assign('PICKIST_DEPENDENCY_DATASOURCE', Zend_Json::encode($sp573574)); $spe5b48c->assign('RECORD_STRUCTURE_MODEL', $sp5b1318); $spe5b48c->assign('RECORD_STRUCTURE', $sp5b1318->getStructure()); $spe5b48c->assign('MODULE', $spf92122); $spe5b48c->assign('CURRENTDATE', date('Y-n-j')); $spe5b48c->assign('USER_MODEL', Users_Record_Model::getCurrentUserModel()); return $spe5b48c->view('EditView.tpl', $spf92122, true); } } class SPCallPopup_EditRecordStructure_Model extends Vtiger_EditRecordStructure_Model { public function filterBySelectedModule($sp0142e8) { $spa95f1e = Settings_SPCallPopup_Mapping_Model::getCleanInstance(); $this->getStructure(); $sp4f3b67 = array_keys($spa95f1e->getModuleMapping($sp0142e8)); foreach ($this->structuredValues as $spbab50c => $sp7303ae) { foreach (array_keys($sp7303ae) as $sp8d15db) { if ($spa95f1e->hasMapping($sp8d15db) && !in_array($sp8d15db, $sp4f3b67)) { unset($this->structuredValues[$spbab50c][$sp8d15db]); } } } $this->spff4133(); } public function removeMappingFields() { $spa95f1e = Settings_SPCallPopup_Mapping_Model::getCleanInstance(); $this->getStructure(); foreach ($this->structuredValues as $spbab50c => $sp7303ae) { foreach (array_keys($sp7303ae) as $sp8d15db) { if ($spa95f1e->hasMapping($sp8d15db)) { unset($this->structuredValues[$spbab50c][$sp8d15db]); } } } $this->spff4133(); } private function spff4133() { foreach ($this->structuredValues as $spbab50c => $sp7303ae) { if (empty($sp7303ae)) { unset($this->structuredValues[$spbab50c]); } } } } class SPCallPopup_MarkPopupProcessed_Action extends Vtiger_Save_Action { private static $handlingErrorsTypes = array(E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR, E_USER_ERROR, E_RECOVERABLE_ERROR); private static $isResponseSend; private static $currentPopupRecordId; public function process(Vtiger_Request $sp6774fb) { self::$isResponseSend = false; register_shutdown_function(array($this, 'errorShutdownHandler')); $sp6096a7 = new Vtiger_Response(); $this->saveRecord($sp6774fb); $sp6096a7->setResult(true); $sp6096a7->emit(); self::$isResponseSend = true; } public function errorShutdownHandler() { if (!self::$isResponseSend) { $sp7a5f0f = Vtiger_Module_Model::getInstance('SPCallPopup'); $sp7a5f0f->markPopupUnprocessed(self::$currentPopupRecordId); $sp783a21 = ob_get_contents(); ob_clean(); $spaab168 = error_get_last(); $sp6147c9 = array('defaultNotification' => vtranslate('LBL_ERROR_ENTITIES_CREATE', 'SPCallPopup'), 'errorDetails' => array()); if ($sp783a21 != null) { $sp6147c9['errorDetails']['vtigerCoreMessages'] = vtranslate('LBL_VTIGER_CORE_MESSAGES', 'SPCallPopup') . ': ' . $sp783a21; } if ($spaab168 != null && in_array($spaab168['type'], self::$handlingErrorsTypes)) { $sp6147c9['errorDetails']['lastErrorDetails'] = vtranslate('LBL_LAST_ERROR_DETAILS', 'SPCallPopup') . ': ' . $spaab168['message'] . ' ' . vtranslate('LBL_IN_FILE', 'SPCallPopup') . ' ' . $spaab168['file'] . ' ' . vtranslate('LBL_ON_LINE', 'SPCallPopup') . ' ' . $spaab168['line']; } header('HTTP/1.1 200'); $sp6096a7 = new Vtiger_Response(); $sp6096a7->setError($sp6147c9); $sp6096a7->emit(); die; } } protected function getRecordModelFromRequest(\Vtiger_Request $sp6774fb) { $sp236f41 = parent::getRecordModelFromRequest($sp6774fb); $sp236f41->set('status', 1); self::$currentPopupRecordId = $sp236f41->getId(); return $sp236f41; } } class SPCallPopup_Edit_View extends Vtiger_Edit_View { public function checkPermission(Vtiger_Request $sp6774fb) { throw new AppException(vtranslate('LBL_PERMISSION_DENIED')); } } class Settings_SPCallPopup_MappingDelete_Action extends Settings_Vtiger_Index_Action { public function process(Vtiger_Request $sp6774fb) { $sp3e25e7 = $sp6774fb->get('mappingId'); $sp39776d = $sp6774fb->getModule(false); $sp6096a7 = new Vtiger_Response(); if ($sp3e25e7) { Settings_SPCallPopup_Mapping_Model::deleteMapping(array($sp3e25e7)); $sp6096a7->setResult(array(vtranslate('LBL_DELETED_SUCCESSFULLY', $sp39776d))); } else { $sp6096a7->setError(vtranslate('LBL_INVALID_MAPPING', $sp39776d)); } $sp6096a7->emit(); } } class Settings_SPCallPopup_MappingSave_Action extends Settings_Vtiger_Index_Action { public function process(Vtiger_Request $sp6774fb) { $spa2072e = $sp6774fb->get('mapping'); $sp526706 = $spa2072e['defaultMappingModule']; unset($spa2072e['defaultMappingModule']); unset($spa2072e['__vtrftk']); $spa95f1e = Settings_SPCallPopup_Mapping_Model::getCleanInstance(); $sp6096a7 = new Vtiger_Response(); if ($spa2072e) { $spa95f1e->save($spa2072e); $spa95f1e->saveDefaultMappingModule($sp526706); $sped8be5 = array('status' => true); } else { $sped8be5['status'] = false; } $sp6096a7->setResult($sped8be5); return $sp6096a7->emit(); } public function validateRequest(Vtiger_Request $sp6774fb) { $sp6774fb->validateWriteAccess(); } } class Settings_SPCallPopup_Field_Model extends Vtiger_Field_Model { public function getFieldDataType() { $spc9d36c = ''; $sp948dfd = $this->get('uitype'); if ($sp948dfd == '9') { $spc9d36c = 'percent'; } if (!$spc9d36c) { $spff9f70 = $this->getWebserviceFieldObject(); $spc9d36c = $spff9f70->getFieldDataType(); switch ($spc9d36c) { case 'text': $spc9d36c = 'textArea'; break; case 'boolean': $spc9d36c = 'checkBox'; break; case 'multipicklist': $spc9d36c = 'multiSelectCombo'; break; } } return $spc9d36c; } public static function getCleanInstance() { return new self(); } public static function getInstance($sp0a37f9, $sp739fec) { $sp30bfbd = parent::getInstance($sp0a37f9, $sp739fec); $sp6f8707 = get_object_vars($sp30bfbd); $sp30bfbd = new self(); foreach ($sp6f8707 as $sp01746d => $sp891ab9) { $sp30bfbd->{$sp01746d} = $sp891ab9; } return $sp30bfbd; } } class Settings_SPCallPopup_Mapping_Model extends Settings_Vtiger_Module_Model { var $name = 'SPCallPopup'; private $moduleToColumn = array('Contacts' => 'contactfid', 'Leads' => 'leadfid', 'Accounts' => 'accountfid'); public function getDetailViewUrl() { return 'index.php?parent=' . $this->getParentName() . '&module=' . $this->getName() . '&view=MappingDetail'; } public function getEditViewUrl() { return 'index.php?parent=' . $this->getParentName() . '&module=' . $this->getName() . '&view=MappingEdit'; } public function getMappingDeleteUrl() { return 'parent=' . $this->getParentName() . '&module=' . $this->getName() . '&action=MappingDelete'; } public function getHeaders() { return array('SPCallPopup' => 'SPCallPopup', 'Type' => 'Type', 'Leads' => 'Leads', 'Contacts' => 'Contacts', 'Accounts' => 'Accounts'); } public function getDetailViewLinks() { return array(Vtiger_Link_Model::getInstanceFromValues(array('linktype' => 'DETAILVIEW', 'linklabel' => 'LBL_EDIT', 'linkurl' => $this->getEditViewUrl(), 'linkicon' => ''))); } public function getMappingLinks() { return array(Vtiger_Link_Model::getInstanceFromValues(array('linktype' => 'DETAILVIEW', 'linklabel' => 'LBL_DELETE', 'linkurl' => 'javascript:Settings_SPCallPopup_MappingEdit_Js.triggerDelete(event,"' . $this->getMappingDeleteUrl() . '")', 'linkicon' => ''))); } public function hasMapping($spa2ff0a) { $sp30bfbd = Vtiger_Field_Model::getInstance($spa2ff0a, Vtiger_Module_Model::getInstance('SPCallPopup')); if ($sp30bfbd) { $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->pquery('SELECT * FROM vtiger_sp_convert_popup_mapping WHERE popupfid=? LIMIT 1', array($sp30bfbd->getId())); return $sped8be5 && ($spfa9c85 = $sp376434->fetchByAssoc($sped8be5)); } return false; } public function getDefaultMappingModuleName() { $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->query('SELECT modulename FROM vtiger_sp_mapping_default LIMIT 1'); $sp559068 = 'Leads'; if ($sped8be5 && ($spfa9c85 = $sp376434->fetchByAssoc($sped8be5))) { $sp559068 = $spfa9c85['modulename']; } return $sp559068; } public function getModuleMapping($spf92122) { $spa2072e = array(); if (array_key_exists($spf92122, $this->moduleToColumn)) { $spfc1429 = $this->moduleToColumn[$spf92122]; $sp95a9dc = 'SELECT popupfid, ' . $spfc1429 . ' FROM vtiger_sp_convert_popup_mapping'; $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->query($sp95a9dc); if ($sped8be5) { $spc33675 = Vtiger_Module_Model::getInstance('SPCallPopup'); $spc8ee30 = Vtiger_Module_Model::getInstance($spf92122); while ($spfa9c85 = $sp376434->fetchByAssoc($sped8be5)) { $sp57c725 = $spfa9c85['popupfid']; $spece6d5 = $spfa9c85[$spfc1429]; $spf08643 = Vtiger_Field_Model::getInstance($sp57c725, $spc33675); $spb540da = Vtiger_Field_Model::getInstance($spece6d5, $spc8ee30); if ($spf08643 && $spb540da) { $spa2072e[$spf08643->getName()] = $spb540da->getName(); } } } } return $spa2072e; } public function getMapping($sp515694 = false) { if (!$this->mapping) { $sp376434 = PearDatabase::getInstance(); $sp95a9dc = 'SELECT * FROM vtiger_sp_convert_popup_mapping'; if ($sp515694) { $sp95a9dc .= ' WHERE editable = 1'; } $sped8be5 = $sp376434->pquery($sp95a9dc, array()); $sp1f37b9 = $sp376434->num_rows($sped8be5); $spa2072e = array(); for ($spb620cf = 0; $spb620cf < $sp1f37b9; $spb620cf++) { $sp740758 = $sp376434->query_result_rowdata($sped8be5, $spb620cf); $spa2072e[$sp740758['id']] = $sp740758; } $sp5d24b3 = $sp061042 = array(); foreach ($spa2072e as $sp3efaa0) { array_push($sp061042, $sp3efaa0['popupfid'], $sp3efaa0['leadfid'], $sp3efaa0['contactfid'], $sp3efaa0['accountfid']); } $spa63dee = array(); if (!empty($sp061042)) { $spa63dee = $this->getFieldsInfo(array_unique($sp061042)); } foreach ($spa2072e as $spd3cfe2 => $sp3efaa0) { $sp5d24b3[$spd3cfe2] = array('editable' => $sp3efaa0['editable'], 'SPCallPopup' => $spa63dee[$sp3efaa0['popupfid']], 'Leads' => $spa63dee[$sp3efaa0['leadfid']], 'Contacts' => $spa63dee[$sp3efaa0['contactfid']], 'Accounts' => $spa63dee[$sp3efaa0['accountfid']]); } $this->mapping = $sp5d24b3; } return $this->mapping; } public function getFieldsInfo($sp061042) { $spded790 = Vtiger_Module_Model::getInstance($this->getName()); $sp3f47a8 = $spded790->getId(); $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->pquery('SELECT fieldid, fieldlabel, uitype, typeofdata, fieldname, tablename, tabid FROM vtiger_field WHERE fieldid IN (' . generateQuestionMarks($sp061042) . ')', $sp061042); $sp1f37b9 = $sp376434->num_rows($sped8be5); $spa63dee = array(); for ($spb620cf = 0; $spb620cf < $sp1f37b9; $spb620cf++) { $sp740758 = $sp376434->query_result_rowdata($sped8be5, $spb620cf); $sp672f06 = array('id' => $sp740758['fieldid'], 'label' => $sp740758['fieldlabel']); if ($sp740758['tabid'] === $sp3f47a8) { $sp30bfbd = Settings_Leads_Field_Model::getCleanInstance(); $sp30bfbd->set('uitype', $sp740758['uitype']); $sp30bfbd->set('typeofdata', $sp740758['typeofdata']); $sp30bfbd->set('name', $sp740758['fieldname']); $sp30bfbd->set('table', $sp740758['tablename']); $sp672f06['fieldDataType'] = $sp30bfbd->getFieldDataType(); } $spa63dee[$sp740758['fieldid']] = $sp672f06; } return $spa63dee; } public function saveDefaultMappingModule($spf92122) { if (!empty($spf92122)) { $sp376434 = PearDatabase::getInstance(); if ($this->sp5e9533()) { $sp376434->pquery('UPDATE vtiger_sp_mapping_default SET modulename=?', array($spf92122)); } else { $sp376434->pquery('INSERT INTO vtiger_sp_mapping_default(modulename) VALUES(?)', array($spf92122)); } } } private function sp5e9533() { $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->query('SELECT COUNT(*) AS rowscount FROM vtiger_sp_mapping_default'); if ($sped8be5 && ($spfa9c85 = $sp376434->fetchByAssoc($sped8be5))) { return $spfa9c85['rowscount'] > 0; } return false; } public function save($spa2072e) { $sp376434 = PearDatabase::getInstance(); $sp92bcdf = $sp42fcde = $spfb9588 = array(); foreach ($spa2072e as $sp3efaa0) { $spd3cfe2 = $sp3efaa0['mappingId']; if ($sp3efaa0['popup']) { if ($spd3cfe2) { if (array_key_exists('deletable', $sp3efaa0) || !$sp3efaa0['lead'] && !$sp3efaa0['contact'] && !$sp3efaa0['account']) { $sp92bcdf[] = $spd3cfe2; } else { if ($sp3efaa0['lead'] || $sp3efaa0['contact'] || $sp3efaa0['account']) { $sp42fcde[] = $sp3efaa0; } } } else { if ($sp3efaa0['lead'] || $sp3efaa0['contact'] || $sp3efaa0['account']) { $spfb9588[] = $sp3efaa0; } } } } if ($sp92bcdf) { $sp376434->pquery('DELETE FROM vtiger_sp_convert_popup_mapping WHERE editable = 1 AND id IN (' . generateQuestionMarks($sp92bcdf) . ')', $sp92bcdf); } if ($spfb9588) { $this->createMappings($spfb9588); } if ($sp42fcde) { $this->updateMappings($sp42fcde); } } public function createMappings($spfb9588) { if (!empty($spfb9588)) { $sp52b3c3 = 'INSERT INTO vtiger_sp_convert_popup_mapping(popupfid, leadfid, contactfid, accountfid) VALUES '; $spaa7f0f = array(); $sp5bc26e = array(); foreach ($spfb9588 as $sp2ba497) { $spaa7f0f[] = $sp2ba497['popup']; $spaa7f0f[] = $sp2ba497['lead']; $spaa7f0f[] = $sp2ba497['contact']; $spaa7f0f[] = $sp2ba497['account']; $sp5bc26e[] = '(?,?,?,?)'; } $sp52b3c3 .= join(',', $sp5bc26e); $sp376434 = PearDatabase::getInstance(); $sp376434->pquery($sp52b3c3, $spaa7f0f); } } public function updateMappings($sp42fcde) { $spe6453a = ' SET popupfid = CASE '; $spf9cea2 = ' leadfid = CASE '; $sp08ed8f = ' contactfid = CASE '; $spd1a8b1 = ' accountfid = CASE '; foreach ($sp42fcde as $sp3efaa0) { $spd3cfe2 = $sp3efaa0['mappingId']; $spe6453a .= " WHEN id = {$spd3cfe2} THEN " . $sp3efaa0['popup']; $spf9cea2 .= " WHEN id = {$spd3cfe2} THEN " . $sp3efaa0['lead']; $sp08ed8f .= " WHEN id = {$spd3cfe2} THEN " . $sp3efaa0['contact']; $spd1a8b1 .= " WHEN id= {$spd3cfe2} THEN " . $sp3efaa0['account']; } $spe6453a .= ' ELSE popupfid END '; $spf9cea2 .= ' ELSE leadfid END '; $sp08ed8f .= ' ELSE contactfid END '; $spd1a8b1 .= ' ELSE accountfid END '; $sp376434 = PearDatabase::getInstance(); $sp376434->pquery("UPDATE vtiger_sp_convert_popup_mapping {$spe6453a}, {$spf9cea2}, {$sp08ed8f}, {$spd1a8b1} WHERE editable = ?", array(1)); } public static function getRestrictedFieldIdsList() { $sp376434 = PearDatabase::getInstance(); $sped8be5 = $sp376434->pquery('SELECT * FROM vtiger_sp_convert_popup_mapping WHERE editable = ?', array(0)); $sp1f37b9 = $sp376434->num_rows($sped8be5); $spd396a6 = array(); for ($spb620cf = 0; $spb620cf < $sp1f37b9; $spb620cf++) { $sp740758 = $sp376434->query_result_rowdata($sped8be5, $spb620cf); if ($sp740758['leadfid']) { $spd396a6[] = $sp740758['leadfid']; } if ($sp740758['contactfid']) { $spd396a6[] = $sp740758['contactfid']; } if ($sp740758['accountfid']) { $spd396a6[] = $sp740758['accountfid']; } } return $spd396a6; } public static function getSupportedModulesList() { return array('Leads', 'Contacts', 'Accounts'); } public static function getInstance($sp515694 = false) { $spe27104 = new self(); $spe27104->getMapping($sp515694); return $spe27104; } public static function getCleanInstance() { return new self(); } public static function deleteMapping($sp5cbf23) { $sp376434 = PearDatabase::getInstance(); $sp376434->pquery('DELETE FROM vtiger_sp_convert_popup_mapping WHERE id IN (' . generateQuestionMarks($sp5cbf23) . ')', $sp5cbf23); } } class Settings_SPCallPopup_Module_Model extends Settings_Vtiger_Module_Model { } class Settings_SPCallPopup_MappingDetail_View extends Settings_Vtiger_Index_View { public function process(Vtiger_Request $sp6774fb) { $sp39776d = $sp6774fb->getModule(false); $spe5b48c = $this->getViewer($sp6774fb); $spe5b48c->assign('MAPPING', Settings_SPCallPopup_Mapping_Model::getInstance()); $spe5b48c->assign('ERROR_MESSAGE', $sp6774fb->get('errorMessage')); $spe5b48c->assign('QUALIFIED_MODULE', $sp39776d); $spe5b48c->view('MappingDetail.tpl', $sp39776d); } function getHeaderScripts(Vtiger_Request $sp6774fb) { $sp00c94b = parent::getHeaderScripts($sp6774fb); $spf92122 = $sp6774fb->getModule(); $sp7fb07a = $this->checkAndConvertJsScripts(array("modules.Settings.{$spf92122}.resources.SPCallPopupMapping")); return array_merge($sp00c94b, $sp7fb07a); } } class SPCallPopup_Module_Wrapper extends Vtiger_Module_Model { public function getFields() { if (!$this->fields) { $sp5ea96b = array(); $spc8492f = $this->getMappingSupportedFieldIdsList(); foreach ($spc8492f as $spfdd233) { $sp30bfbd = Settings_SPCallPopup_Field_Model::getInstance($spfdd233, $this); $sp5ea96b[$sp30bfbd->getFieldDataType()][$spfdd233] = $sp30bfbd; } $this->fields = $sp5ea96b; } return $this->fields; } public function getMappingSupportedFieldIdsList() { if (!$this->supportedFieldIdsList) { $spb50b2b[] = getTabid($this->getName()); $sp73b64a = array(0, 2); $sp621478 = array('campaignrelstatus'); $spccf8ff = $this->getRestrictedUitypes(); $sp4d07f1 = array(1, 2); $sp376434 = PearDatabase::getInstance(); $sp95a9dc = 'SELECT fieldid FROM vtiger_field
						WHERE presence IN (' . generateQuestionMarks($sp73b64a) . ')
						AND tabid IN (' . generateQuestionMarks($spb50b2b) . ')
						AND uitype NOT IN (' . generateQuestionMarks($spccf8ff) . ')
						AND fieldname NOT IN (' . generateQuestionMarks($sp621478) . ')
						AND generatedtype IN (' . generateQuestionMarks($sp4d07f1) . ')'; $sp5e7fab = array_merge($sp73b64a, $spb50b2b, $spccf8ff, $sp621478, $sp4d07f1); $sped8be5 = $sp376434->pquery($sp95a9dc, $sp5e7fab); $sp1f37b9 = $sp376434->num_rows($sped8be5); $sp061042 = array(); for ($spb620cf = 0; $spb620cf < $sp1f37b9; $spb620cf++) { $sp061042[] = $sp376434->query_result($sped8be5, $spb620cf, 'fieldid'); } $this->supportedFieldIdsList = $sp061042; } return $this->supportedFieldIdsList; } public function getRestrictedUitypes() { return array(4, 51, 69, 70); } public static function getInstance($spf92122) { $sp7a5f0f = parent::getInstance($spf92122); $sp6f8707 = get_object_vars($sp7a5f0f); $sp7a5f0f = new self(); foreach ($sp6f8707 as $sp01746d => $sp891ab9) { $sp7a5f0f->{$sp01746d} = $sp891ab9; } return $sp7a5f0f; } } class Settings_SPCallPopup_MappingEdit_View extends Settings_Vtiger_Index_View { public function process(Vtiger_Request $sp6774fb) { $sp39776d = $sp6774fb->getModule(false); $spe5b48c = $this->getViewer($sp6774fb); $spe5b48c->assign('MAPPING', Settings_SPCallPopup_Mapping_Model::getInstance(true)); $spe5b48c->assign('SPCALLPOPUP_MODULE_MODEL', SPCallPopup_Module_Wrapper::getInstance('SPCallPopup')); $spe5b48c->assign('LEADS_MODULE_MODEL', SPCallPopup_Module_Wrapper::getInstance('Leads')); $spe5b48c->assign('CONTACTS_MODULE_MODEL', SPCallPopup_Module_Wrapper::getInstance('Contacts')); $spe5b48c->assign('ACCOUNTS_MODULE_MODEL', SPCallPopup_Module_Wrapper::getInstance('Accounts')); $spe5b48c->assign('QUALIFIED_MODULE', $sp39776d); $spe5b48c->view('MappingEdit.tpl', $sp39776d); } function getHeaderScripts(Vtiger_Request $sp6774fb) { $sp00c94b = parent::getHeaderScripts($sp6774fb); $spf92122 = $sp6774fb->getModule(); $sp7fb07a = $this->checkAndConvertJsScripts(array("modules.Settings.{$spf92122}.resources.SPCallPopupMapping")); return array_merge($sp00c94b, $sp7fb07a); } } class SPCallPopup_Detail_View extends Vtiger_Detail_View { public function isAjaxEnabled($sp236f41) { return false; } } function SPCallPopupCustomTask($sp5cca67) { $spede485 = $sp5cca67->getId(); list($sp7097e0, $spc5e0b0) = vtws_getIdComponents($spede485); if (!SPCallPopup_Record_Model::isEntityDeleted($spc5e0b0)) { $sp29474b = SPCallPopup_Record_Model::getInstanceById($spc5e0b0, $sp5cca67->getModuleName()); SPProcessPopupSave($sp29474b); } } function SPProcessPopupSave($sp29474b) { $sp670866 = $sp29474b->getClientModel(); $sp34464a = $sp29474b->getCallModel(); if ($sp670866 == null) { $spf5b838 = $sp29474b->get('client_type'); $sp29494d = Vtiger_Module_Model::getInstance($spf5b838); $sp670866 = Vtiger_Record_Model::getCleanInstance($spf5b838); $sp93704d = $sp29494d->getFieldsByType('phone'); if (!empty($sp93704d)) { $sp6c8702 = current($sp93704d); $sp670866->set($sp6c8702->getName(), $sp34464a->get('customernumber')); } $spa95f1e = Settings_SPCallPopup_Mapping_Model::getCleanInstance(); $spa2072e = $spa95f1e->getModuleMapping($spf5b838); foreach ($spa2072e as $spa2ff0a => $spa3f2dd) { $sp670866->set($spa3f2dd, $sp29474b->get($spa2ff0a)); } $sp670866->set('assigned_user_id', $sp34464a->get('user')); $sp670866->save(); $sp34464a->updateCallDetails(array('customer' => $sp670866->getId(), 'customertype' => $spf5b838), $sp34464a->get('user')); } else { $sp29494d = $sp670866->getModule(); } $spfa691b = PBXManager_Module_Model::getInstance('PBXManager'); $sp63e4bf = Vtiger_Relation_Model::getInstance($sp29494d, $spfa691b); if ($sp63e4bf) { $sp63e4bf->addRelation($sp670866->getId(), $sp34464a->get('pbxmanagerid')); } $sp63e4bf = Vtiger_Relation_Model::getInstance($sp29474b->getModule(), $sp29494d); if ($sp63e4bf) { $sp63e4bf->addRelation($sp29474b->getId(), $sp670866->getId()); } $sp63e4bf = Vtiger_Relation_Model::getInstance($sp29494d, $sp29474b->getModule()); if ($sp63e4bf) { $sp63e4bf->addRelation($sp670866->getId(), $sp29474b->getId()); } }